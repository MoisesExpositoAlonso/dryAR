---
title: Growth trajectories exploration, variance proportion
  missing pots
author: "Moises Exposito-Alonso (moisesexpositoalonso@gmail.com)"
date: '`r Sys.Date()`'
output:
  html_document: default
  pdf_document: default
  
---

<!-- ## Packages set up and loading data -->

<!-- ```{r setup, include=F} -->
<!-- library(knitr) -->
<!-- library(dplyr,tidyr) -->
<!-- library(ggplot2);library(cowplot) -->
<!-- library(devtools) -->
<!-- library(RColorBrewer) -->
<!-- # library(moiR) -->
<!-- load_all("~/moiR") -->
<!-- load_all(".") -->

<!-- data(veggy) -->
<!-- data(veg) -->

<!-- ``` -->

<!-- ##  Plotting the sigmoidal curves of 1000 pots  -->

<!-- ```{r trajectory plot} -->

<!-- veg$ss.na<-veg$ss.a == "NA" ## need to filter for NAs -->
<!-- table(veg$ss.na) -->
<!-- vegh<- veg %>% dplyr::filter(ss.na != TRUE) %>% -->
<!--   mutate(ss.a=removetail(ss.a), -->
<!--           ss.b=removetail(ss.b), -->
<!--           ss.c=removetail(ss.c))  -->


<!-- vegh=vegh[sample(1:nrow(vegh), size = 500),] -->
<!-- dim(vegh) -->


<!-- plot( ylab='Predicted # pixels',xlab='Days of experiment', -->
<!--   ylim=c(0,50000), -->
<!--   y= -->
<!-- getsigmoid( -->
<!--   a=vegh$ss.a[1], -->
<!--   b=vegh$ss.b[1], -->
<!--   c=vegh$ss.c[1] -->
<!-- ), -->
<!-- x=1:40, -->
<!-- type='l' -->
<!-- ) -->

<!-- for( i in 1:nrow(vegh)){ -->
<!-- lines(  y= -->
<!-- getsigmoid( -->
<!--   a=vegh$ss.a[i], -->
<!--   b=vegh$ss.b[i], -->
<!--   c=vegh$ss.c[i] -->
<!-- ), -->
<!-- x=1:40, -->
<!-- col=transparent('black') -->
<!-- ) -->
<!-- } -->

<!-- set_project_dir() -->
<!-- p <- recordPlot() -->
<!-- set_project_dir() -->
<!-- pdf(file = 'figs/Figure_growth_trajectories.pdf',useDingbats = F,width = 5,height = 5) -->
<!-- p # redraw -->
<!-- dev.off() -->

<!-- ``` -->

<!-- ##  Germination plot -->

<!-- ```{r germination plot} -->

<!-- p1=ggplot(veg) + -->
<!--   geom_histogram(aes(x=spline1,group=water,fill=water,alpha=0.3)) + scale_fill_manual(values = c("h"="navy","l"="red3"))+facet_grid(site~indpop)+theme_bw() -->
<!-- p1=p1 + xlab('Germination time since sowing (days)') + scale_alpha(guide = 'none') -->
<!-- p1 -->
<!-- save_plot(filename = 'figs/Figure_germination_distribution.pdf',base_height = 5,base_width = 5, plot=p1) -->

<!-- ``` -->

<!-- ## Calculate various variance proportions of the modeled trajectories. -->

<!-- ```{r calculate} -->
<!-- library(lme4) -->
<!-- library(MCMCglmm) -->

<!-- veg %>% -->
<!--   filter(redsum < 1e4) %>% -->
<!--   # filter(greensum >1e4) %>% -->
<!--   mutate( -->
<!--   a= removetail(ger.a,4), -->
<!--   b= removetail(ger.b,4), -->
<!--   c= removetail(ger.c,4) -->
<!--   ) %>% -->
<!-- lmer(formula = a ~ (1|id) + (1|water)+ (1|site) + (1|indpop)  ) -> lmod  -->
<!-- lmod %>% randomvariance(.,var =c('id','water','site',"indpop") ) -->

<!-- ``` -->
<!-- ```{r} -->
<!-- veg %>% -->
<!--   filter(redsum < 1e4) %>% -->
<!--   # filter(greensum >1e4) %>% -->
<!--   mutate( -->
<!--   a= removetail(ger.a,4), -->
<!--   b= removetail(ger.b,4), -->
<!--   c= removetail(ger.c,4) -->
<!--   ) %>% -->
<!-- lmer(formula = b ~ (1|id) + (1|water)+ (1|site) + (1|indpop)  ) -> lmod -->
<!-- lmod %>% randomvariance(.,var =c('id','water','site',"indpop") ) -->

<!-- ``` -->

<!-- ```{r} -->

<!-- veg %>% -->
<!--   filter(redsum < 1e4) %>% -->
<!--   # filter(greensum >1e4) %>% -->
<!--   mutate( -->
<!--   a= removetail(ger.a,4), -->
<!--   b= removetail(ger.b,4), -->
<!--   c= removetail(ger.c,4) -->
<!--   ) %>% -->
<!-- lmer(formula = c ~ (1|id) + (1|water)+ (1|site) + (1|indpop)  ) -> lmod  -->
<!-- lmod %>% randomvariance(.,var =c('id','water','site',"indpop") ) -->

<!-- ``` -->

<!-- Not very satisfactory. Most of the effect is about individual versus population replicates -->

<!-- ### Calculate variance in a per-experiment treatment basis  -->

<!-- ```{r} -->
<!-- veg %>% -->
<!--   filter(redsum < 1e4) %>% -->
<!--   # filter(greensum >1e4) %>% -->
<!--   mutate( -->
<!--   a= removetail(ger.a,4), -->
<!--   b= removetail(ger.b,4), -->
<!--   c= removetail(ger.c,4), -->
<!--   l=removetail(lin.0) -->
<!--   ) %>% -->
<!--   filter(water=='h', indpop=='i', site=='madrid') %>% -->
<!-- # lmer(formula = b ~ (1|id) ) -> lmod  -->
<!-- # lmer(formula = a ~ (1|id) ) -> lmod  -->
<!-- # lmer(formula = c ~ (1|id) ) -> lmod  -->
<!-- # lmer(formula = greensum ~ (1|id) ) -> lmod -->
<!-- # lmer(formula = redsum ~ (1|id) ) -> lmod -->
<!-- lmer(formula = l ~ (1|id) ) -> lmod -->
<!-- lmod %>% randomvariance(.,var =c('id') ) -->


<!-- ``` -->



<!-- ```{r, session info, echo=FALSE} -->
<!-- sessionInfo() -->

<!-- ``` -->

